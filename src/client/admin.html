<script type="text/javascript" src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
<style type="text/css">
body, td, p, div {
	font: normal 13px "Segoe UI",helvetica,arial,sans-serif;
	color: #5A5A5A;
}

#status span { color: green; }

#container > div {
	float: left;
	margin-right: 2px;
	height: 100%;
}

#nicks, #chat, #input {
	border: 1px solid black;
	padding: 5px;
}

#sidebar, #nicks { min-width: 200px; }
#lobby { min-width: 765px; }
#chat, #nicks { overflow-y:scroll; height: 330px; display: block; }
#input { margin-top: 5px; height: 20px; width: 70%; }
select, input[type="submit"] { width: 107px; height: 20px; }
#container {
	min-width: 1000px;
	height: 50%;
}
.join { color: #78AB46; }
.part { color: #990000; }
.active { font-weight: bold; }
</style>

<div id="status">
	<b>XWISAdmin</b> (XAR)<br />
	RA2: <span>online</span>; TS: <span>online</span>
</div>
<hr />
<div id="chans">
	<span class="active">#Lob_18_0</span> | <span>#Lob_33_0</span> | <span>#Lob_41_0</span>
</div>
<hr />

<div id="container" data-channel="#Lob_18_0">
	<div id="lobby">
		<div id="chat">
		</div>

		<select>
			<option value="#Lob_18_0">#Lobby_18_0</option>
			<option value="#Lob_33_0">#Lobby_33_0</option>
			<option value="#Lob_41_0">#Lobby_41_0</option>
		</select>
		<input type="text" id="input" />
		<input type="submit" value="Submit" />
	</div>

	<div id="sidebar">
		<select id="nicks" size="30">
		</select>

		<button>Drop</button> <button>Chat ban</button>
	</div>
</div>

<script type="text/javascript">
(function ($) {
	$(document).ready(function () {
		var master = {
			current: $('#container').data('channel'),

			channels: {
				'#Lob_18_0': {games: [], lobby: []},
				'#Lob_33_0': {games: [], lobby: []},
				'#Lob_41_0': {games: [], lobby: []}
			},

			__join: function (channel, nick) {
				var bunker =  this.channels[channel];
				if (typeof bunker != 'undefined'){
					if (bunker.lobby.indexOf(nick) < 0) {
						bunker.lobby.push(nick);
						var $list = $('#container[data-channel="'+ channel +'"] #nicks');
						if ($list.length > 0) $list.append('<option value="'+ nick +'">'+ nick +'</option>');
					}
				}
			},

			__part: function (channel, nick) {
				var bunker = this.channels[channel];
				if (typeof bunker != 'undefined'){
					var index = bunker.lobby.indexOf(nick);
					if (index > -1) {
						bunker.lobby.splice(index, 1);
						var $nick = $('#container[data-channel="'+ channel +'"] #nicks option[value="'+ nick +'"]');
						if ($nick.length > 0) $nick.remove();
					}
				}
			},

			__switch: function (channel) {
				var bunker = this.channels[channel];
				if (typeof bunker != 'undefined') {
					$('#container').attr('data-channel', channel);
					this.current = channel;
					$('#chat, #nicks').html(' ');
					var $list =  $('#container[data-channel="'+ channel +'"] #nicks');
					for(i in bunker.lobby) {
						$list.append('<option value="'+ bunker.lobby[i] +'">'+ bunker.lobby[i] +'</option>');
					}
					$('#chans span.active').removeClass('active');
					$('#chans span:contains("'+ channel +'")').addClass('active');
				}

			},

			__lobby: function (action) {
				var date = new Date();
				var stamp = '['+ date.getHours() +':'+ (date.getMinutes() < 10 ? '0' : '')+ date.getMinutes() +']';
				$('#chat').append('<div>'+stamp +' '+ action +'</div>');
				var chat = document.getElementById('chat');
				chat.scrollTop = chat.scrollHeight;
			}
		};

		console.log(master);

		var socket = new WebSocket('ws://xwis.co.uk:1337');
		socket.onopen = function () {
			socket.send('helo');
		};

		socket.onmessage = function (message) {
			var data = $.parseJSON(message.data);
			console.log(data);
			switch(data.type) {
				case 'join':
					var user = data.message[0], channel = data.message[1];
					master.__join(channel, user);
					if (channel == master.current) {
						master.__lobby('<em class="join">'+ user +' joined</em>');
					}
				break;

				case 'part':
					var user = data.message[0], channel = data.message[1];
					master.__part(channel, user);
					if (channel == master.current) {
						master.__lobby('<em class="part">'+ user +' left</em>');
					}
				break;

				case 'message':
					var user = data.message[0],
						channel = data.message[1],
						content = data.message[2];

					if (channel == master.current) {
						master.__lobby('&lt;'+ user +'&gt; '+ content);
					}
				break;
			}
		}

		$('input#input').bind('keyup', function (event){
			if (event.keyCode == 13) {
				$('input[type="submit"]').click();
			}
		});

		$('input[type="submit"]').bind('click', function (event) {
			event.preventDefault();
			var channel = $('select :selected').val(),
				message = $('#input').val();

			if (message.length > 0) {
				socket.send(['PRIVMSG', channel, ':'+ message].join(' '));
				master.__lobby('&lt;XWISAdmin&gt; '+ message);
				$('#input').val('');
			}
			return false;
		});

		$('select').bind('change', function (event) {
			master.__switch(this.value);
		});
	});
})(jQuery);
</script>
